# æ›´æ–°æ—¥å¿—

## ç‰ˆæœ¬ 2.0 - é±¼çœ¼åŸŸåˆæˆå·¥ä½œæµ (2025-12-21)

### ğŸ¯ æ ¸å¿ƒæ”¹è¿›

å®ç°äº†å…¨æ–°çš„å·¥ä½œæµç¨‹ï¼š**ä¿æŒå‰æ™¯ä¸ºåŸå§‹é±¼çœ¼æ ¼å¼ï¼Œå¯¹èƒŒæ™¯åŠ ç•¸å˜ä½¿å…¶åŒ¹é…å‚è€ƒå›¾é£æ ¼**

### ğŸ”„ ä¸»è¦å˜åŒ–

#### 1. æ–°çš„å¤„ç†æµç¨‹

**ä¹‹å‰çš„æµç¨‹ï¼ˆv1.0ï¼‰ï¼š**
```
é±¼çœ¼å‰æ™¯ â†’ å»ç•¸å˜ â†’ é’ˆå­”åŸŸå¤„ç† â†’ åˆæˆ â†’ è¾“å‡ºé’ˆå­”å›¾åƒ
```
- âŒ åŒé‡é‡é‡‡æ ·å¯¼è‡´ç”»è´¨æŸå¤±
- âŒ æœ€ç»ˆè¾“å‡ºæ˜¯é’ˆå­”å›¾åƒï¼Œä¸ç¬¦åˆé±¼çœ¼ç›¸æœºåº”ç”¨åœºæ™¯

**ç°åœ¨çš„æµç¨‹ï¼ˆv2.0ï¼‰ï¼š**
```
é±¼çœ¼å‰æ™¯ â†’ ä¿æŒä¸åŠ¨
é’ˆå­”èƒŒæ™¯ â†’ æ·±åº¦ä¼°è®¡ â†’ ç”Ÿæˆç«‹ä½“èƒŒæ™¯ â†’ åŠ é±¼çœ¼ç•¸å˜ â†’ åˆæˆ â†’ è¾“å‡ºé±¼çœ¼å›¾åƒ
```
- âœ… å‰æ™¯ä¿æŒåŸå§‹ç”»è´¨
- âœ… æœ€ç»ˆè¾“å‡ºæ˜¯é±¼çœ¼æ ¼å¼ï¼Œç›´æ¥å¯ç”¨
- âœ… é¿å…äº†ä¸å¿…è¦çš„å»ç•¸å˜æ­¥éª¤

#### 2. æ–°å¢åŠŸèƒ½

- **`convert_pinhole_to_fisheye()`**: é’ˆå­”åˆ°é±¼çœ¼çš„æŠ•å½±å‡½æ•°
  - ä½¿ç”¨ `cv2.omnidir.undistortPoints` åæŠ•å½±åˆ°çƒé¢
  - æ”¯æŒä¸åŒçš„é±¼çœ¼ç›¸æœºå†…å‚ï¼ˆK, xiï¼‰
  - è‡ªåŠ¨å¤„ç†ç•¸å˜æ˜ å°„

- **`run_fisheye_background_replacement()`**: ä¸»å¤„ç†å‡½æ•°
  - æ›¿ä»£åŸæ¥çš„ `run_end_to_end_with_depth_estimation()`
  - æ”¯æŒæ·±åº¦å¼•å¯¼å’Œä¸¤é˜¶æ®µå•åº”ä¸¤ç§æ–¹æ³•
  - åœ¨é±¼çœ¼åŸŸè¿›è¡Œæœ€ç»ˆåˆæˆ

#### 3. ç§»é™¤çš„åŠŸèƒ½

- âŒ `preprocess_fisheye_image()`: é±¼çœ¼å»ç•¸å˜é¢„å¤„ç†
- âŒ `run_preprocessing_pipeline()`: æ‰¹é‡é¢„å¤„ç†ç®¡é“
- âŒ `temp_undistorted/` ç›®å½•ï¼šä¸å†éœ€è¦ä¸´æ—¶å»ç•¸å˜æ–‡ä»¶

### ğŸ“ API å˜åŒ–

#### ä¸»å‡½æ•°ç­¾åå˜åŒ–

**æ—§ç‰ˆï¼š**
```python
run_end_to_end_with_depth_estimation(
    background_path,
    foreground_left_path,
    foreground_right_path,
    mask_left_path,
    mask_right_path,
    reference_left_path=None,
    reference_right_path=None,
    output_dir="output",
    use_depth_method=True,
    depth_params=None
)
```

**æ–°ç‰ˆï¼š**
```python
run_fisheye_background_replacement(
    background_path,
    foreground_left_path,
    foreground_right_path,
    mask_left_path,
    mask_right_path,
    params_left,          # æ–°å¢ï¼šå·¦ç›¸æœºå‚æ•°
    params_right,         # æ–°å¢ï¼šå³ç›¸æœºå‚æ•°
    output_dir="output",
    depth_params=None,
    reference_left_path=None,
    reference_right_path=None,
    use_depth_method=True
)
```

#### è¾“å…¥æ•°æ®è¦æ±‚å˜åŒ–

**æ—§ç‰ˆï¼š**
- å‰æ™¯/æ©ç ï¼šé±¼çœ¼å›¾åƒï¼ˆä¼šè¢«å»ç•¸å˜ï¼‰
- èƒŒæ™¯ï¼šé±¼çœ¼å›¾åƒï¼ˆä¼šè¢«å»ç•¸å˜ï¼‰

**æ–°ç‰ˆï¼š**
- å‰æ™¯/æ©ç ï¼š**é±¼çœ¼å›¾åƒï¼ˆä¿æŒåŸæ ·ï¼‰**
- èƒŒæ™¯ï¼š**é’ˆå­”å›¾åƒï¼ˆä¸è¦ç•¸å˜ï¼‰**

### ğŸ¨ è¾“å‡ºæ–‡ä»¶å˜åŒ–

**æ—§ç‰ˆè¾“å‡ºï¼š**
```
output/
â”œâ”€â”€ result_depth_left.jpg
â”œâ”€â”€ result_depth_right.jpg
â”œâ”€â”€ result_two_stage_left.jpg
â”œâ”€â”€ result_two_stage_right.jpg
â”œâ”€â”€ estimated_depth.png
â””â”€â”€ warped_bg_*.jpg
```

**æ–°ç‰ˆè¾“å‡ºï¼š**
```
output/
â”œâ”€â”€ final_fisheye_left_depth.jpg      # æœ€ç»ˆé±¼çœ¼åˆæˆå›¾ï¼ˆæ·±åº¦æ–¹æ³•ï¼‰
â”œâ”€â”€ final_fisheye_right_depth.jpg
â”œâ”€â”€ final_fisheye_left_homography.jpg # æœ€ç»ˆé±¼çœ¼åˆæˆå›¾ï¼ˆå•åº”æ–¹æ³•ï¼‰
â”œâ”€â”€ final_fisheye_right_homography.jpg
â”œâ”€â”€ depth_visualization.jpg            # æ·±åº¦å¯è§†åŒ–
â”œâ”€â”€ depth_map.png                      # æ·±åº¦å›¾æ•°æ®
â”œâ”€â”€ debug_pinhole_bg_left.jpg         # ä¸­é—´æ€ï¼šé’ˆå­”ç«‹ä½“èƒŒæ™¯
â”œâ”€â”€ debug_pinhole_bg_right.jpg
â”œâ”€â”€ debug_fisheye_bg_left.jpg         # ä¸­é—´æ€ï¼šé±¼çœ¼æŠ•å½±èƒŒæ™¯
â””â”€â”€ debug_fisheye_bg_right.jpg
```

### ğŸ“– æ–‡æ¡£æ›´æ–°

- **README.md**: å®Œå…¨é‡å†™ï¼Œåæ˜ æ–°çš„å·¥ä½œæµç¨‹
  - æ›´æ–°äº†ç®€ä»‹å’Œç‰¹æ€§è¯´æ˜
  - ä¿®æ”¹äº†å¿«é€Ÿå¼€å§‹æŒ‡å—
  - å¢åŠ äº†å‚æ•°è¯´æ˜
  - æ›´æ–°äº†å¸¸è§é—®é¢˜è§£ç­”

### ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

```python
# å®šä¹‰é±¼çœ¼ç›¸æœºå‚æ•°
params_left = {
    "K": [[1027.71, 0.00, 320.00],
          [0.00, 1027.71, 320.00],
          [0.00, 0.00, 1.00]],
    "xi": 0.976611
}

params_right = {
    "K": [[1099.93, 0.00, 320.00],
          [0.00, 1099.93, 320.00],
          [0.00, 0.00, 1.00]],
    "xi": 0.905052
}

# è¿è¡Œå¤„ç†
run_fisheye_background_replacement(
    background_path='bg.jpg',           # é’ˆå­”èƒŒæ™¯
    foreground_left_path='fg_L.png',    # é±¼çœ¼å‰æ™¯
    foreground_right_path='fg_R.png',
    mask_left_path='mask_L.png',        # é±¼çœ¼æ©ç 
    mask_right_path='mask_R.png',
    params_left=params_left,
    params_right=params_right,
    depth_params={
        'hfov_deg': 90.0,
        'baseline': 0.065,
        'rotation_y_deg': 5.0
    }
)
```

### âš ï¸ è¿ç§»æŒ‡å—

å¦‚æœä½ æ­£åœ¨ä½¿ç”¨æ—§ç‰ˆä»£ç ï¼Œéœ€è¦è¿›è¡Œä»¥ä¸‹è°ƒæ•´ï¼š

1. **å‡†å¤‡é’ˆå­”èƒŒæ™¯å›¾**ï¼š
   - å¦‚æœèƒŒæ™¯æ˜¯é±¼çœ¼ï¼Œéœ€è¦å…ˆæ‰‹åŠ¨å»ç•¸å˜
   - æˆ–è€…ä½¿ç”¨æ™®é€šç›¸æœºæ‹æ‘„çš„èƒŒæ™¯å›¾

2. **å‰æ™¯å’Œæ©ç ä¿æŒé±¼çœ¼æ ¼å¼**ï¼š
   - ä¸è¦å¯¹å‰æ™¯å’Œæ©ç è¿›è¡Œå»ç•¸å˜
   - ç¡®ä¿å®ƒä»¬ä¸åŸå§‹é±¼çœ¼ç›¸æœºè¾“å‡ºä¸€è‡´

3. **æä¾›ç›¸æœºå‚æ•°**ï¼š
   - å¿…é¡»æä¾› `params_left` å’Œ `params_right`
   - åŒ…å«å†…å‚çŸ©é˜µ K å’Œç•¸å˜å‚æ•° xi

4. **æ›´æ–°å‡½æ•°è°ƒç”¨**ï¼š
   - å°† `run_end_to_end_with_depth_estimation()` æ”¹ä¸º `run_fisheye_background_replacement()`
   - æ·»åŠ ç›¸æœºå‚æ•°åˆ°å‡½æ•°è°ƒç”¨ä¸­

### ğŸ› å·²çŸ¥é—®é¢˜

- å¦‚æœè™šæ‹Ÿé’ˆå­”ç›¸æœºè§†åœºè§’è®¾ç½®ä¸å½“ï¼Œé±¼çœ¼èƒŒæ™¯è¾¹ç¼˜å¯èƒ½å‡ºç°é»‘è¾¹
- ä¸¤é˜¶æ®µæ–¹æ³•å¯¹çº¹ç†ä¸ä¸°å¯Œçš„åœºæ™¯æ•ˆæœå¯èƒ½ä¸ä½³

### ğŸ“Š æ€§èƒ½

- å®Œæ•´æµç¨‹ï¼šçº¦ 3-6 ç§’ï¼ˆ640x480, GTX 1080 Tiï¼‰
- é±¼çœ¼æŠ•å½±å¼€é”€ï¼šçº¦ 0.4 ç§’ï¼ˆæ¯å¯¹å›¾åƒï¼‰

### ğŸ™ è‡´è°¢

æ„Ÿè°¢ç”¨æˆ·æå‡ºçš„ä¼˜åŒ–å»ºè®®ï¼Œæ–°çš„å·¥ä½œæµç¨‹æ›´ç¬¦åˆå®é™…åº”ç”¨åœºæ™¯ï¼

